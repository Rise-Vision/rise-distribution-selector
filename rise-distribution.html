<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="rise-bs-modal.html">
<link rel="import" href="rise-spin.html">
<link rel="import" href="../google-apis/google-client-loader.html">
<script src="../underscore/underscore.js"></script>


<!--
An element providing a solution to no problem in particular.

Example:

    <rise-distribution></rise-distribution>

@demo
-->
<dom-module id="rise-distribution">

  <template>
    <div class="content-box-editable remove-bottom clickable" on-tap="openDialog">
      <div class="label label-tag">4 displays</div>
    </div>

     <span>{{test}}</span><br>

    <google-client-loader api-root="https://rvaserver2.appspot.com/_ah/api" id="coreAPI"
                          name="core"
                          version="v1"></google-client-loader>

    <rise-bs-modal open="{{ dialogOpen }}" on-backgroundtap="closeDialog">
      <div class="modal-header">
        <button type="button" class="close" on-tap="closeDialog" aria-hidden="true">
          <i class="fa fa-times"></i>
        </button>
        <h3 class="modal-title">Edit Distribution</h3>
      </div>
      <div class="modal-body">

        <div class="form-group">
          <label class="control-label"><input type="checkbox" class="add-right" on-tap="selectAll"> All Displays</label>
        </div>

        <div class="input-group add-bottom">
          <span class="input-group-addon"><i class="fa fa-search fa-lg"></i></span>
          <input type="text" class="form-control" placeholder="Search Displays">
        </div>

        <div class="content-box scrollable-list">
          <table class="table-2 table-hover animated fadeIn table-selector multiple-selector">
            <thead>
            <tr>
              <th>Name</th>
              <th>Address</th>
            </tr>
            </thead>
            <tbody>
            <rise-spin show="{{ loading }}"></rise-spin>
            <template is="dom-repeat" items="{{displays}}">
              <tr on-tap="select" id="{{ item.id }}">
                <td>{{item.name}}</td>
                <td><span class="text-muted">{{item.address}}</span></td>
              </tr>
            </template>

            </tbody>
          </table>
        </div><!--content-box-->
      </div>
      <div class="modal-footer">
        <button class="btn-primary btn" on-tap="apply">Apply <i class="fa fa-check icon-right"></i></button>
        <button class="btn btn-default" on-tap="closeDialog">Cancel <i class="fa fa-times icon-right"></i></button>
      </div>
    </rise-bs-modal>

    <content></content>
  </template>

</dom-module>

<script>

  Polymer({

    is: 'rise-distribution',

    properties: {
      company: {
        type: String,
        reflectToAttribute: true
      },
      distribution: {
        type: Object,
        value: function () {
          return {};
        },
        reflectToAttribute: true
      },
      appId: String,

      apiRoot: {
        type: String,
        value: "https://rvaserver2.appspot.com/_ah/api"
      }
    },

    // Element Lifecycle

    ready: function() {
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.

    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).


    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    // Element Behavior
    displays: [],
    loading: false,

    _load: function () {
      console.log("Calling display list");

      var coreAPI = document.getElementById('coreAPI');
      var request = coreAPI.api.display.list({
        companyId: this.companyId
      });
      this.loading = true;
      request.execute(this._handleResponse.bind(this));
    },

    _handleResponse: function (resp) {
      console.debug("Api response: ",resp);
      if(resp.result){
        this.displays = resp.items;

        this.async(this._showCurrentDistribution.bind(this));
      }else{
        console.debug("Displays could not be retrieved");
      }
      this.loading = false;
    },

    _showCurrentDistribution: function () {

      if(this.displays.length !== this.distribution.length){
        _.each(this.distribution, this._selectItemForCurrentDistribution.bind(this));
      }
    },

    _selectItemForCurrentDistribution: function (item) {
      this.toggleClass('active', true, this.$$("[id='"+item+"']"));
    },

    openDialog: function () {
      console.debug("Open Dialog");
      this.displays = [];
      this._load();
      this.dialogOpen = true;
    },
    closeDialog: function () {
      this.dialogOpen = false;
    },

    apply: function () {
      console.log(this.distribution);
      this.closeDialog();
    },

    select: function (event) {
      var currentTarget = event.currentTarget;
      var classList = currentTarget.classList;

      if(classList.contains("active")){
        classList.remove("active")
        this.distribution = _.without(this.distribution, currentTarget.id);
      }else{
        this.distribution = this.distribution.concat(currentTarget.id);
        classList.add("active")
      }
    }
  });

</script>
